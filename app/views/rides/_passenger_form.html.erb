<%= form_with(model: ride, class: "contents", data: { controller: "places-autocomplete" }) do |form| %>
  <% if ride.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mt-3">
      <h2><%= pluralize(ride.errors.count, "error") %> prohibited this ride from being saved:</h2>
      <ul class="list-disc ml-6">
        <% ride.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="w-full lg:flex">
    <!-- Left side - Form -->
    <div class="lg:w-1/2 p-6 rounded-2xl shadow-lg bg-white mb-6 lg:mb-0">
      <h2 class="text-xl font-medium text-gray-700 mb-6">Book a ride</h2>

      <!-- Pickup Location -->
      <div class="my-5 relative">
        <%= form.label :pickup_location, "From", class: "block font-medium text-gray-500" %>
        <%= form.text_field :pickup_location,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                          placeholder: "Enter a pickup location",
                          data: { action: "input->places-autocomplete#fetchSuggestions", places_autocomplete_target: "pickupInput" } %>

        <!-- Suggestions Dropdown -->
        <div data-places-autocomplete-target="pickupSuggestions" class="autocomplete-dropdown z-10 absolute w-full bg-white shadow-lg rounded-md"></div>

        <%= form.hidden_field :pickup_address, data: { places_autocomplete_target: "pickupAddress" } %>
        <%= form.hidden_field :pickup_lat, data: { places_autocomplete_target: "pickupLat", map_target: "pickupLat" } %>
        <%= form.hidden_field :pickup_lng, data: { places_autocomplete_target: "pickupLng", map_target: "pickupLng" } %>
      </div>

      <!-- Dropoff Location -->
      <div class="my-5 relative">
        <%= form.label :dropoff_location, "To", class: "block font-medium text-gray-500" %>
        <%= form.text_field :dropoff_location,
                          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                          placeholder: "Enter a destination",
                          data: { action: "input->places-autocomplete#fetchSuggestions", places_autocomplete_target: "dropoffInput" } %>

        <!-- Suggestions Dropdown -->
        <div data-places-autocomplete-target="dropoffSuggestions" class="autocomplete-dropdown z-10 absolute w-full bg-white shadow-lg rounded-md"></div>

        <%= form.hidden_field :dropoff_address, data: { places_autocomplete_target: "dropoffAddress" } %>
        <%= form.hidden_field :dropoff_lat, data: { places_autocomplete_target: "dropoffLat", map_target: "dropoffLat" } %>
        <%= form.hidden_field :dropoff_lng, data: { places_autocomplete_target: "dropoffLng", map_target: "dropoffLng" } %>
      </div>

      <div class="my-5">
        <%= form.label :scheduled_time, "Schedule time", class: "block font-medium text-gray-500" %>
        <%= form.datetime_field :scheduled_time, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div class="my-5">
        <%= form.label :requested_seats, "Requested seats", class: "block font-medium text-gray-500" %>
        <%= form.number_field :requested_seats, min: 1, max: 10, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <div class="my-5">
        <%= form.label :special_instructions, "Special Instructions", class: "block font-medium text-gray-500" %>
        <%= form.text_area :special_instructions, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" %>
      </div>

      <!-- Trip Information (shows when route is calculated) -->
      <div id="trip-info" class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden">
        <h3 class="text-base font-semibold text-gray-700 mb-2">Trip Information</h3>
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <p class="text-xs uppercase text-gray-400 font-semibold">Distance</p>
            <p id="trip-distance" class="font-bold text-gray-800">--</p>
          </div>
          <div>
            <p class="text-xs uppercase text-gray-400 font-semibold">Time</p>
            <p id="trip-duration" class="font-bold text-gray-800">--</p>
          </div>
          <div>
            <p class="text-xs uppercase text-gray-400 font-semibold">Status</p>
            <p class="font-bold text-gray-800">Pending</p>
          </div>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mt-6">
        <%= form.submit "Create Ride", class: "rounded-lg px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium cursor-pointer" %>
        <%= link_to "Back to dashboard", rides_path, class: "rounded-lg px-4 py-2 bg-gray-100 hover:bg-gray-50 text-blue-600 border border-blue-600 font-medium text-center" %>
      </div>
    </div>

    <!-- Right side - Map -->
    <div class="lg:w-1/2 lg:pl-6 h-full">
      <div 
        id="map-container"
        class="w-full h-[400px] lg:h-full rounded-lg overflow-hidden map-container"
        data-controller="map"
        data-map-target="mapContainer"
        data-action="places-autocomplete:locationChanged@document->map#updateFromPlaces">
      </div>
    </div>
  </div>
<% end %>

<style>
  /* Autocomplete dropdown styles */
  .autocomplete-dropdown {
    display: none;
    max-height: 200px;
    overflow-y: auto;
    position: absolute;
    width: 100%;
    background-color: white;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    z-index: 10;
    margin-top: 2px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .autocomplete-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #e2e8f0;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-item:hover {
    background-color: #f3f4f6;
    transition: background-color 0.2s;
  }
  
  /* Map container styles */
  .map-container {
    width: 100%;
    height: 400px;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  @media (min-width: 1024px) {
    .map-container {
      height: 100%;
      min-height: 500px;
    }
  }

  /* Mobile optimization */
  @media (max-width: 768px) {
    .contents {
      flex-direction: column;
    }
    
    .lg\:flex {
      flex-direction: column;
    }
    
    .lg\:w-1\/2 {
      width: 100%;
    }
    
    .lg\:pl-6 {
      padding-left: 0;
      padding-top: 1.5rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, setting up event listeners");
    
    // Listen for route:calculated event to show trip info
    document.addEventListener('route:calculated', function(event) {
      console.log("Received route:calculated event:", event.detail);
      const tripInfo = document.getElementById('trip-info');
      const tripDistance = document.getElementById('trip-distance');
      const tripDuration = document.getElementById('trip-duration');
      
      tripInfo.classList.remove('hidden');
      tripDistance.textContent = event.detail.distance;
      tripDuration.textContent = event.detail.duration;
    });
  });
</script>
